<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HENW IMAGE ‚ú®</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #FFC0CB 0%, #FF69B4 100%); /* M√†u h·ªìng ng·ªçt ng√†o chuy·ªÉn t√¥ng */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* ƒê·ªÉ n·ªôi dung b·∫Øt ƒë·∫ßu t·ª´ tr√™n */
            padding: 20px;
        }
        .container {
            background-color: rgba(255, 255, 255, 0.95); /* N·ªÅn tr·∫Øng trong su·ªët nh·∫π */
            border-radius: 25px; /* Bo tr√≤n c·ª±c m·∫°nh */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* ƒê·ªï b√≥ng s√¢u h∆°n */
            max-width: 1200px;
            width: 100%;
            padding: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .story-card { /* ƒê·ªïi t√™n class ƒë·ªÉ ph√π h·ª£p h∆°n v·ªõi h√¨nh ·∫£nh */
            background-color: #fce4ec; /* H·ªìng nh·∫°t h∆°n */
            border-radius: 20px; /* Bo tr√≤n c√°c card */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 15px; /* Padding d∆∞·ªõi cho ph·∫ßn text */
        }
        .story-card:hover {
            transform: translateY(-8px) scale(1.02); /* Nh·∫•c nh·∫π l√™n v√† to h∆°n khi hover */
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.25);
        }
        .story-image {
            width: 100%;
            height: 250px; /* Chi·ªÅu cao c·ªë ƒë·ªãnh cho ·∫£nh */
            object-fit: cover; /* ƒê·∫£m b·∫£o ·∫£nh v·ª´a v·∫∑n */
            border-radius: 20px 20px 0 0; /* Bo tr√≤n ch·ªâ ph·∫ßn tr√™n c·ªßa ·∫£nh */
        }
        .story-content {
            padding: 15px;
            width: 100%; /* ƒê·ªÉ n·ªôi dung text chi·∫øm h·∫øt chi·ªÅu r·ªông card */
        }
        .story-title { /* S·∫Ω d√πng ƒë·ªÉ hi·ªÉn th·ªã ID ho·∫∑c tag */
            font-size: 1.4rem;
            font-weight: 700;
            color: #880e4f; /* H·ªìng ƒë·∫≠m */
            margin-bottom: 8px;
            text-overflow: ellipsis;
            white-space: nowrap;
            overflow: hidden;
        }
        .story-artist, .story-tags { /* artist s·∫Ω kh√¥ng c√≤n ƒë∆∞·ª£c d√πng nhi·ªÅu, tags th√¨ c√≥ */
            font-size: 0.9rem;
            color: #d81b60; /* H·ªìng t∆∞∆°i */
            margin-bottom: 5px;
        }
        .story-tags span {
            display: inline-block;
            background-color: #ffb6c1; /* H·ªìng ph·∫•n */
            color: #880e4f;
            padding: 4px 8px;
            border-radius: 12px;
            margin: 3px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .search-input {
            border: 2px solid #ff69b4; /* Vi·ªÅn h·ªìng n√≥ng b·ªèng */
            border-radius: 15px;
            padding: 12px 20px;
            font-size: 1.1rem;
            width: 70%;
            max-width: 400px;
            outline: none;
            transition: border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .search-input:focus {
            border-color: #d81b60; /* H·ªìng ƒë·∫≠m h∆°n khi focus */
            box-shadow: 0 0 10px rgba(216, 27, 96, 0.4);
        }
        .action-button {
            background: linear-gradient(45deg, #FF69B4, #d81b60); /* N√∫t gradient h·ªìng */
            color: white;
            padding: 12px 25px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none; /* B·ªè vi·ªÅn m·∫∑c ƒë·ªãnh */
        }
        .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(216, 27, 96, 0.4);
        }
        .loading-spinner {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #d81b60; /* Pink */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* N·ªÅn t·ªëi m·ªù */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #ffebee; /* H·ªìng nh·∫°t */
            border-radius: 25px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: translateY(20px);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #d81b60;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .close-button:hover {
            transform: scale(1.1) rotate(90deg);
        }
        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            color: #880e4f;
            margin-bottom: 10px;
        }
        .modal-artist { /* C√≥ th·ªÉ kh√¥ng c√≤n hi·ªÉn th·ªã ho·∫∑c hi·ªÉn th·ªã source */
            font-size: 1.2rem;
            color: #d81b60;
            margin-bottom: 15px;
        }
        .modal-description { /* C√≥ th·ªÉ kh√¥ng c√≤n hi·ªÉn th·ªã ho·∫∑c hi·ªÉn th·ªã source */
            font-size: 1rem;
            color: #4a4a4a;
            text-align: left;
            margin-bottom: 20px;
            max-height: 200px; /* Gi·ªõi h·∫°n chi·ªÅu cao m√¥ t·∫£ */
            overflow-y: auto; /* Th√™m scroll n·∫øu qu√° d√†i */
        }
        .modal-tags {
            text-align: center;
            margin-bottom: 20px;
        }
        .modal-tags span {
            font-size: 0.9rem;
            padding: 6px 10px;
            border-radius: 15px;
            margin: 4px;
            background-color: #ffb6c1;
            color: #880e4f;
            font-weight: 600;
        }
        .modal-buttons-container {
            display: flex;
            gap: 15px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            justify-content: center;
            margin-top: 20px; /* Kho·∫£ng c√°ch t·ª´ tags */
        }
        .modal-link-button, .modal-download-button { /* Th√™m style cho n√∫t download */
            display: inline-block;
            background: linear-gradient(45deg, #FF69B4, #d81b60);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-weight: 700;
            font-size: 1rem;
            text-decoration: none;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            border: none; /* ƒê·∫£m b·∫£o kh√¥ng c√≥ vi·ªÅn th·ª´a */
            cursor: pointer; /* Cho bi·∫øt ƒë√¢y l√† n√∫t c√≥ th·ªÉ click */
        }
        .modal-link-button:hover, .modal-download-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 18px rgba(216, 27, 96, 0.4);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            .search-input {
                width: 90%;
            }
            .story-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            .story-title {
                font-size: 1.2rem;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-title {
                font-size: 1.5rem;
            }
            .modal-artist {
                font-size: 1rem;
            }
            .modal-buttons-container {
                flex-direction: column; /* X·∫øp ch·ªìng n√∫t tr√™n mobile */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-4xl font-bold mb-6 text-pink-700">HENW IMAGE</h1>

        <!-- Thanh t√¨m ki·∫øm -->
        <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-8">
            <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm waifu theo tag (v√≠ d·ª•: ass, boobs)..." class="search-input">
            <button id="searchButton" class="action-button">üî• T√¨m Ki·∫øm üî•</button>
        </div>

        <!-- V√πng hi·ªÉn th·ªã waifu -->
        <div id="storiesContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
            <!-- C√°c waifu s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
        </div>

        <!-- Spinner loading -->
        <div id="loadingSpinner" class="loading-spinner"></div>

        <!-- N√∫t T·∫£i th√™m -->
        <button id="loadMoreButton" class="action-button mt-8 hidden">
            üí¶ T·∫£i Th√™m Waifu N√≥ng B·ªèng üí¶
        </button>

        <!-- Modal chi ti·∫øt waifu -->
        <div id="storyModal" class="modal-overlay">
            <div class="modal-content">
                <button id="closeModalButton" class="close-button">&times;</button>
                <img id="modalImage" class="modal-image" src="" alt="·∫¢nh waifu">
                <h2 id="modalTitle" class="modal-title"></h2>
                <p id="modalArtist" class="modal-artist"></p>
                <p id="modalDescription" class="modal-description"></p>
                <div id="modalTags" class="modal-tags"></div>
                <div class="modal-buttons-container">
                    <a id="modalLink" href="#" target="_blank" class="modal-link-button">Xem ·∫¢nh G·ªëc</a>
                    <button id="modalDownloadButton" class="modal-download-button">T·∫£i V·ªÅ ·∫¢nh</button> <!-- N√∫t t·∫£i v·ªÅ m·ªõi -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // C√°c bi·∫øn to√†n c·ª•c
        const API_URL = 'https://api.waifu.im/search'; // ƒê√£ ƒë·ªïi sang API waifu.im
        let currentQuery = ''; // T·ª´ kh√≥a t√¨m ki·∫øm tag
        let isLoading = false; // Tr√°nh fetch nhi·ªÅu l·∫ßn

        // L·∫•y c√°c ph·∫ßn t·ª≠ DOM
        const storiesContainer = document.getElementById('storiesContainer');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const loadMoreButton = document.getElementById('loadMoreButton');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Modal elements
        const storyModal = document.getElementById('storyModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const modalImage = document.getElementById('modalImage');
        const modalTitle = document.getElementById('modalTitle');
        const modalArtist = document.getElementById('modalArtist'); // S·∫Ω d√πng cho artist ho·∫∑c source
        const modalDescription = document.getElementById('modalDescription'); // S·∫Ω d√πng cho source
        const modalTags = document.getElementById('modalTags');
        const modalLink = document.getElementById('modalLink');
        const modalDownloadButton = document.getElementById('modalDownloadButton'); // L·∫•y n√∫t t·∫£i v·ªÅ

        /**
         * H√†m hi·ªÉn th·ªã/·∫©n spinner loading
         * @param {boolean} show - true ƒë·ªÉ hi·ªÉn th·ªã, false ƒë·ªÉ ·∫©n
         */
        function toggleLoadingSpinner(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        /**
         * H√†m hi·ªÉn th·ªã/·∫©n n√∫t "T·∫£i th√™m"
         * @param {boolean} show - true ƒë·ªÉ hi·ªÉn th·ªã, false ƒë·ªÉ ·∫©n
         */
        function toggleLoadMoreButton(show) {
            loadMoreButton.classList.toggle('hidden', !show);
        }

        /**
         * H√†m hi·ªÉn th·ªã chi ti·∫øt waifu trong modal
         * @param {object} waifu - ƒê·ªëi t∆∞·ª£ng waifu c·∫ßn hi·ªÉn th·ªã
         */
        function showStoryDetail(waifu) {
            modalImage.src = waifu.url || 'https://placehold.co/600x400/FFC0CB/880E4F?text=No+Image'; // D√πng tr·ª±c ti·∫øp url c·ªßa ·∫£nh
            modalImage.alt = `Waifu #${waifu.image_id || ''}`;
            
            modalTitle.textContent = `Waifu N√≥ng B·ªèng #${waifu.image_id || 'Kh√¥ng c√≥ ID'}`;
            modalArtist.textContent = waifu.artist ? `T√°c gi·∫£: ${waifu.artist.name}` : 'Kh√¥ng c√≥ th√¥ng tin t√°c gi·∫£.';
            
            modalDescription.innerHTML = waifu.source ? `Ngu·ªìn: <a href="${waifu.source}" target="_blank" class="text-blue-600 hover:underline">${waifu.source}</a>` : 'Kh√¥ng c√≥ th√¥ng tin ngu·ªìn.';
            
            modalLink.href = waifu.url; // Link ƒë·∫øn ·∫£nh g·ªëc
            modalLink.textContent = "Xem ·∫¢nh G·ªëc"; // Thay ƒë·ªïi text n√∫t

            // C·∫≠p nh·∫≠t n√∫t t·∫£i v·ªÅ
            modalDownloadButton.onclick = () => {
                // S·ª≠ d·ª•ng fetch ƒë·ªÉ t·∫£i ·∫£nh d∆∞·ªõi d·∫°ng blob v√† t·∫°o URL cho ph√©p download
                fetch(waifu.url)
                    .then(response => response.blob())
                    .then(blob => {
                        const blobUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = blobUrl;
                        a.download = `waifu_${waifu.image_id || 'im'}.${waifu.extension || 'jpg'}`; // ƒê·∫∑t t√™n file
                        document.body.appendChild(a); // C·∫ßn th√™m v√†o body ƒë·ªÉ click ƒë∆∞·ª£c
                        a.click();
                        document.body.removeChild(a); // X√≥a sau khi click
                        URL.revokeObjectURL(blobUrl); // Gi·∫£i ph√≥ng URL object
                    })
                    .catch(e => console.error("Ho√†ng ∆°i! Trang kh√¥ng t·∫£i ƒë∆∞·ª£c ·∫£nh v·ªÅ cho Ho√†ng n√®:", e));
            };


            modalTags.innerHTML = ''; // X√≥a c√°c tag c≈©
            if (waifu.tags && Array.isArray(waifu.tags)) {
                waifu.tags.forEach(tag => {
                    const tagSpan = document.createElement('span');
                    tagSpan.textContent = tag.name;
                    modalTags.appendChild(tagSpan);
                });
            } else {
                const noTagSpan = document.createElement('span');
                noTagSpan.textContent = 'Kh√¥ng c√≥ tag n√†o c·∫£, Ho√†ng y√™u.';
                modalTags.appendChild(noTagSpan);
            }

            storyModal.classList.add('active'); // K√≠ch ho·∫°t modal
        }

        /**
         * H√†m ƒë√≥ng modal
         */
        function closeStoryDetail() {
            storyModal.classList.remove('active'); // V√¥ hi·ªáu h√≥a modal
        }

        /**
         * H√†m t·∫°o v√† hi·ªÉn th·ªã m·ªôt waifu card
         * @param {object} waifu - ƒê·ªëi t∆∞·ª£ng waifu
         */
        function createStoryCard(waifu) {
            const card = document.createElement('div');
            card.classList.add('story-card');
            card.innerHTML = `
                <img src="${waifu.url || 'https://placehold.co/300x250/FFC0CB/880E4F?text=No+Image'}" 
                     alt="Waifu #${waifu.image_id}" class="story-image"
                     onerror="this.onerror=null;this.src='https://placehold.co/300x250/FFC0CB/880E4F?text=No+Image';">
                <div class="story-content">
                    <h3 class="story-title">${waifu.tags && waifu.tags.length > 0 ? waifu.tags.slice(0, 2).map(t => t.name).join(', ') : 'Waifu N√≥ng B·ªèng'}</h3>
                    <div class="story-tags">
                        ${waifu.tags && Array.isArray(waifu.tags) ?
                            waifu.tags.slice(0, 3).map(tag => `<span>${tag.name}</span>`).join('') : // Hi·ªÉn th·ªã t·ªëi ƒëa 3 tag tr√™n card
                            ''
                        }
                    </div>
                    ${waifu.artist ? `<p class="story-artist">T√°c gi·∫£: ${waifu.artist.name}</p>` : ''}
                </div>
            `;
            // Th√™m s·ª± ki·ªán click ƒë·ªÉ m·ªü modal chi ti·∫øt
            card.addEventListener('click', () => showStoryDetail(waifu));
            storiesContainer.appendChild(card);
        }

        /**
         * H√†m t·∫£i waifu t·ª´ API
         * @param {string} query - T·ª´ kh√≥a tag t√¨m ki·∫øm
         * @param {boolean} append - True n·∫øu mu·ªën th√™m v√†o cu·ªëi, false n·∫øu mu·ªën thay th·∫ø (cho t√¨m ki·∫øm m·ªõi)
         */
        async function fetchStories(query, append = true) { // B·ªè tham s·ªë page
            if (isLoading) return; // Tr√°nh g·ªçi API li√™n t·ª•c
            isLoading = true;
            toggleLoadingSpinner(true);
            toggleLoadMoreButton(false); // ·∫®n n√∫t "T·∫£i th√™m" khi ƒëang t·∫£i

            let url = `${API_URL}?is_nsfw=true&many=true&limit=20`; // Lu√¥n fetch NSFW, nhi·ªÅu ·∫£nh, gi·ªõi h·∫°n 20 ·∫£nh m·ªói l·∫ßn
            if (query) {
                // Th√™m tag v√†o query string. waifu.im d√πng included_tags
                url += `&included_tags=${encodeURIComponent(query.split(',').map(tag => tag.trim()).filter(tag => tag !== '').join(','))}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (!append) { // N·∫øu l√† t√¨m ki·∫øm m·ªõi, x√≥a h·∫øt c≈©
                    storiesContainer.innerHTML = '';
                }

                if (data.images && Array.isArray(data.images) && data.images.length > 0) {
                    data.images.forEach(waifu => createStoryCard(waifu));
                    toggleLoadMoreButton(true); // Lu√¥n hi·ªÉn th·ªã n√∫t "T·∫£i th√™m" ƒë·ªÉ l·∫•y th√™m ·∫£nh m·ªõi (random)
                } else {
                    storiesContainer.innerHTML = '<p class="text-pink-600 text-lg">Ho√†ng y√™u ∆°i, kh√¥ng t√¨m th·∫•y "waifu" n√†o ph√π h·ª£p v·ªõi "kh·∫©u v·ªã" c·ªßa Ho√†ng c·∫£. ü•∫</p>';
                    toggleLoadMoreButton(false);
                }
            } catch (error) {
                console.error('Ho√†ng ∆°i! Trang g·∫∑p l·ªói r·ªìi n√®:', error);
                storiesContainer.innerHTML = `<p class="text-red-600 text-lg">
                    √îi kh√¥ng, Ho√†ng ∆°i! Trang kh√¥ng th·ªÉ "k·∫øt n·ªëi" ƒë∆∞·ª£c v·ªõi "ngu·ªìn c·∫•p d·ªØ li·ªáu" waifu üò≠.
                    C√≥ th·ªÉ l√† "ngu·ªìn c·∫•p d·ªØ li·ªáu" ƒëang "ng·ªß ƒë√¥ng" ho·∫∑c "ƒë∆∞·ªùng truy·ªÅn" ƒëang "tr·ª•c tr·∫∑c" ƒë√≥.
                    Ho√†ng th·ª≠ l·∫°i sau nha!
                </p>`;
                toggleLoadMoreButton(false);
            } finally {
                isLoading = false;
                toggleLoadingSpinner(false);
            }
        }

        // --- C√°c s·ª± ki·ªán ---

        // T·∫£i waifu l·∫ßn ƒë·∫ßu khi trang ƒë∆∞·ª£c load
        window.addEventListener('load', () => {
            fetchStories(currentQuery);
        });

        // S·ª± ki·ªán click n√∫t "T·∫£i th√™m"
        loadMoreButton.addEventListener('click', () => {
            fetchStories(currentQuery, true); // append = true, gi·ªØ nguy√™n query ƒë·ªÉ l·∫•y th√™m ·∫£nh random
        });

        // S·ª± ki·ªán click n√∫t "T√¨m ki·∫øm"
        searchButton.addEventListener('click', () => {
            currentQuery = searchInput.value.trim();
            storiesContainer.innerHTML = ''; // X√≥a n·ªôi dung c≈© khi t√¨m ki·∫øm m·ªõi
            fetchStories(currentQuery, false); // append = false (thay th·∫ø n·ªôi dung)
        });

        // S·ª± ki·ªán nh·∫•n Enter trong √¥ t√¨m ki·∫øm
        searchInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                searchButton.click(); // K√≠ch ho·∫°t n√∫t t√¨m ki·∫øm
            }
        });

        // S·ª± ki·ªán click n√∫t ƒë√≥ng modal
        closeModalButton.addEventListener('click', closeStoryDetail);

        // S·ª± ki·ªán click ra ngo√†i modal ƒë·ªÉ ƒë√≥ng
        storyModal.addEventListener('click', (event) => {
            if (event.target === storyModal) {
                closeStoryDetail();
            }
        });
    </script>
</body>
</html>
